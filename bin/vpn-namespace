#!/bin/bash

# Enable bash job control
set -m

trap cleanup SIGHUP SIGINT SIGTERM

function cleanup {
    ip netns delete "$netns"
    ip link delete "$host_veth"
}

confdir="$1"

vpnconfig="$confdir/openconnect.conf"

source "$confdir/vpnns.conf"

netns="$vpn_name"
netns_dir="/etc/netns/$vpn_name"
macvlan_if="$vpn_name"
default_gateway="$(ip route | grep '^default' | awk '{ print $3 }' | head -n 1)"
inet_if="$(ip route | grep '^default' | grep -E -o 'dev \S+' | awk '{ print $2 }')"

mkdir -p "$netns_dir"
grep 'nameserver' /etc/resolv.conf > "$netns_dir/resolv.conf"
chown root:root "$netns_dir/resolv.conf"
chmod 644 "$netns_dir/resolv.conf"

ip netns add "$netns"
ip netns exec "$netns" bash <<EOF &
    while true; do
        if ip link show "$macvlan_if" >/dev/null 2>&1; then
            ip link set dev "$vpn_name" up
            sleep 1
            dhclient -4 "$macvlan_if" -v
            ip route add "$default_gateway/32" dev "$macvlan_if"
            cat /etc/resolv.conf.dhclient-new > /etc/resolv.conf
            rm -f /etc/resolv.conf.dhclient-new
            break
        fi
        sleep 1
    done
    openconnect --config "$vpnconfig" "$server" < /dev/tty
EOF

ip link add link "$inet_if" name "$macvlan_if" type macvlan
ip link set dev "$macvlan_if" netns "$netns"

fg

cleanup
