#!/bin/bash

# Valid values for resolution_mode:

# native: renders at native resolution
#
# Use in Steam by setting the game's command to:
#
# $PATH_TO_GAME_MODE_SCRIPT $RESOLUTION_MODE %command%
resolution_mode=$1; shift

function pregame_tasks {
    sudo "$DOTFILE_DIR/bin/x11/gpufan" 70
    "$DOTFILE_DIR/bin/gui/mouseaccel" off
}

function postgame_tasks {
    sudo "$DOTFILE_DIR/bin/x11/gpufan" auto
    "$DOTFILE_DIR/bin/gui/mouseaccel" on
}

function cleanup {
    if [[ -n "$game_pid" ]]; then
        kill "$game_pid"
    fi
    postgame_tasks
}

if [[ "$resolution_mode" == 'native' ]]; then
    pregame_tasks
    set -x
    "$DOTFILE_DIR/bin/python/with-python-venv" \
        "$DOTFILE_DIR/bin/inhibit/inhibit.py" \
        --application-name 'game-mode' \
        --reason 'game running' \
        "$@" &
    game_pid=$!
    set +x
    trap cleanup EXIT SIGINT SIGTERM
    wait "$game_pid"
else
    echo "unrecognized resolution mode: $resolution_mode" >&2
    exit 1
fi
