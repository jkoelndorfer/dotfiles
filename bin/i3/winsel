#!/bin/bash

script_dir=$(dirname "$0")
cd "$script_dir"

prompt="${1:-window}"
read -r -d '' i3_window_query <<'EOF'
    .[0] as $wsicons | .[1] |
    [recurse(.nodes[], .floating_nodes[]) |
    select(.type == "workspace") |
    .name as $wsname |
    (.nodes[]) |
    .id as $id |
    $wsicons[$wsname]["icon"] as $icon |
    $wsicons[$wsname]["display_indicator"] as $display_indicator |
    .window_properties + {"app_id": .app_id, "name": .name} + {"id": $id, "workspace": $wsname, "workspace_display": "\($icon) \($display_indicator) \($wsname)"} |
    select(.workspace != "__i3_scratch")]
EOF
i3_windows=$((./workspaces -j; ./i3swaymsg -t get_tree) | jq -s -r "$i3_window_query")
win_list="$(echo "$i3_windows" | jq -r '.[] | "\(.workspace_display)\t\(.id)\t\(.class // .app_id)\t\(.title // .name)"' | column -o '    ' -s '	' -t)"
if [[ -n "$WAYLAND_DISPLAY" ]]; then
    selector=("$DOTFILE_DIR/bin/wrappers/wofi" -i --prompt "$prompt")
elif [[ -n "$DISPLAY" ]]; then
    selector=("$DOTFILE_DIR/bin/wrappers/rofi" -dmenu -i -p "$prompt")
else
    echo "$0: Neither WAYLAND_DISPLAY nor DISPLAY are set" >&2
    exit 1
fi
selected_window="$(echo "$win_list" | "${selector[@]}")"
[[ -z "$selected_window" ]] && exit 1
echo "$selected_window" | awk '{ print $4 }'
