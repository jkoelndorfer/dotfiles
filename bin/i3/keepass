#!/bin/bash

# This script assists with summoning and dismissing keepassxc in i3.
# If keepassxc is the active window, it is pushed to another workspace.
# If keepassxc is not open at all, it is opened.
# If keepassxc is open on another workspace, it is pulled to the current
# workspace.

pwsafe_app='keepassxc'
script_dir="$(dirname "$0")"
sleep_interval='0.1'

function keepass_focused() {
    [[ "$("$script_dir/focusedwin" | jq -r '.class')" == "$pwsafe_app" ]]
}

function dismiss_keepass() {
    # Workaround for bug; see
    # https://github.com/i3/i3/issues/2857#issuecomment-496264445
    focused_win=$("$script_dir/focusedwin" | jq -r '.id')
    i3-msg "[class=$pwsafe_app]" focus

    i3-msg "[class=$pwsafe_app]" move scratchpad

    # Continuation of workaround from above
    i3-msg "[con_id=$focused_win]" focus
}

function keepass_win_id() {
    local jq_query="recurse(.nodes[], .floating_nodes[].nodes[]) | select(.window_properties.class == \"$pwsafe_app\") | .id"
    i3-msg -t get_tree | jq -r "$jq_query"
}

if keepass_focused; then
    dismiss_keepass
    exit 0
fi

active_workspace="$(i3-msg -t get_workspaces | jq -r '.[] | select(.focused == true)')"
active_workspace_width="$(echo "$active_workspace" | jq -r '.rect.width')"
active_workspace_height="$(echo "$active_workspace" | jq -r '.rect.height')"

min_keepass_width=800
if [[ "$(( $active_workspace_width / 3 ))" -gt "$min_keepass_width" ]]; then
    keepass_width=$(( $active_workspace_width / 3 ))
else
    keepass_width=$min_keepass_width
fi

if ! pgrep "$pwsafe_app" >/dev/null 2>&1; then
    "$pwsafe_app" >/dev/null 2>&1 & disown
fi
while [[ -z "$(keepass_win_id)" ]]; do
    sleep "$sleep_interval"
done
i3-msg "[class=$pwsafe_app]" scratchpad show
"$script_dir/floatgrid" bottom center "$keepass_width" "$(( $active_workspace_height / 2 ))" "$(keepass_win_id)"
while keepass_focused; do
    sleep "$sleep_interval"
done
dismiss_keepass
