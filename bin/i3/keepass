#!/bin/bash

# This script assists with summoning and dismissing keepassxc in i3.
# If keepassxc is the active window, it is pushed to another workspace.
# If keepassxc is not open at all, it is opened.
# If keepassxc is open on another workspace, it is pulled to the current
# workspace.

pwsafe_app='keepassxc'
script_dir="$(dirname "$0")"
sleep_interval='0.1'

function keepass_focused() {
    [[ "$("$script_dir/focusedwin" | jq -r '.class')" == "$pwsafe_app" ]]
}

function dismiss_keepass() {
    i3-msg "[class=$pwsafe_app]" move scratchpad
}

if keepass_focused; then
    dismiss_keepass
    exit 0
fi

active_workspace="$(i3-msg -t get_workspaces | jq -r '.[] | select(.focused == true)')"
active_workspace_width="$(echo "$active_workspace" | jq -r '.rect.width')"
active_workspace_height="$(echo "$active_workspace" | jq -r '.rect.height')"

if ! pgrep "$pwsafe_app" >/dev/null 2>&1; then
    "$pwsafe_app" >/dev/null 2>&1 & disown
    while ! keepass_focused; do
        "$script_dir/focusedwin"
        sleep "$sleep_interval"
    done
    i3-msg floating enable
else
    i3-msg "[class=$pwsafe_app]" scratchpad show
fi
"$script_dir/floatgrid" bottom center "$(( $active_workspace_width / 3 ))" "$(( $active_workspace_height / 2 ))"
while keepass_focused; do
    sleep "$sleep_interval"
done
dismiss_keepass
