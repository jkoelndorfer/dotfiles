#!/bin/bash

script_dir=$(dirname "$0")
cd "$script_dir"

display_profile=$(../gui/display-profile)

app_cmd=(keepassxc)
# For now, we force KeePassXC to use X11 so we don't want Wayland
# being selected unless there is no other option.
if [[ -n "$WAYLAND_DISPLAY" && -z "$DISPLAY" ]]; then
    # From https://github.com/swaywm/sway/wiki:
    #
    # My favorite application isn't displayed right, how can I fix this?
    # ==================================================================
    #
    # Disabling client-side Qt decorations
    # ------------------------------------
    # Qt currently defaults to using the X11 backend instead of its native
    # Wayland backend. To use the Wayland backend, set `QT_QPA_PLATFORM=wayland`.
    # Then Qt will also draw client-side decorations for all windows, to
    # disable this, set `QT_WAYLAND_DISABLE_WINDOWDECORATION=1`
    export QT_WAYLAND_DISABLE_WINDOWDECORATION=1

    app_window_id_property='.app_id'
    app_window_id_value='org.keepassxc.KeePassXC'
    app_window_wm_selector="[app_id=\"$app_window_id_value\"]"
elif [[ -n "$DISPLAY" ]]; then
    app_window_id_property='.window_properties.class'
    app_window_id_value='KeePassXC'
    app_window_wm_selector="[class=\"$app_window_id_value\"]"
fi
app_horizontal_position='center'
app_vertical_position='bottom'
script_dir="$(dirname "$0")"

function app_width() {
    if [[ "$display_profile" == 'UHD' ]]; then
        local app_min_width='1800'
    else
        local app_min_width='800'
    fi
    if [[ "$(( $active_workspace_width / 3 ))" -gt "$app_min_width" ]]; then
        echo "$(( $active_workspace_width / 3 ))"
    else
        echo "$app_min_width"
    fi
}

function app_height() {
    echo "$(( ($active_workspace_height * 600) / 1000 ))"
}

if [[ "$display_profile" == 'UHD' ]]; then
    # QT_SCALE_FACTOR scales KeePassXC, but unfortunately breaks the mouse
    # within the application entirely. Nothing can be clicked on. But it only
    # happens if the application is present on certain displays. And sometimes
    # the displays where clicks don't work seem to change depending on factors
    # that I haven't determined yet. It's also only a problem in Wayland.
    #
    # The mouse issue with QT_SCALE_FACTOR is not present if we force QT
    # to use X11.
    if [[ -n "$DISPLAY" ]]; then
        export QT_SCALE_FACTOR=2
        export QT_QPA_PLATFORM=xcb
    fi
fi

source "$script_dir/summonapp"
