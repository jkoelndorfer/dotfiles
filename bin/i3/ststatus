#!/bin/bash

# Prints the status of syncthing to stdout suitable for use with polybar or waybar.

script_dir=$(dirname "$0")

source "$script_dir/../../theme/$DESKTOP_THEME/colors"

st_config="$HOME/.config/syncthing/config.xml"
st_api_key=$(xmllint "$st_config" --xpath 'configuration/gui/apikey/text()')

function colorize() {
    msg="$1"
    color="$2"
    if [[ -n "$WAYLAND_DISPLAY" ]]; then
        echo "<span foreground='$color'>$msg</span>"
    else
        echo "%{F$color}$msg%{F-}"
    fi
}

function status() {
    icon="$1"
    color="$2"
    if [[ -z "$WAYLAND_DISPLAY" ]]; then
        echo -n '%{T2}'
    fi
    echo -n "$(colorize '' "$COLORSCHEME_FG_SHADE_2") "
    echo -n "$(colorize "$icon" "$color")"
    if [[ -z "$WAYLAND_DISPLAY" ]]; then
        echo -n '%{T-}'
    fi
}

function s() {
    local suburl="$1"
    shift
    curl -s -H "X-API-Key: $st_api_key" "$@" "http://127.0.0.1:8384/rest/$suburl"
}

if [[ -z "$SYNCTHING_CENTRAL_DEVICE_ID" ]]; then
    status  "$COLORSCHEME_RED"
    exit 0
fi
st_connections=$(s system/connections)
st_status=$(s system/connections | jq -r ".connections.\"${SYNCTHING_CENTRAL_DEVICE_ID}\".connected" 2>/dev/null)
if [[ -z "$st_connections" ]]; then
    status  "$COLORSCHEME_RED"
elif [[ "$st_status" == 'true' ]]; then
    status  "$COLORSCHEME_GREEN"
elif [[ "$st_status" == 'false' ]]; then
    status  "$COLORSCHEME_ORANGE"
else
    status ? "$COLORSCHEME_ORANGE"
fi
