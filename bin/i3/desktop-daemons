#!/bin/zsh -l

wm=$1

if [[ -z "$wm" ]]; then
    echo "$0: must specify window manager, either 'i3' or 'sway'" >&2
    exit 1
fi

display_profile=$("$DOTFILE_DIR/bin/gui/display-profile")
source "$DOTFILE_DIR/lib/sh/gui.sh"

function restart_daemon() {
    local daemon=$1
    shift

    kill_processes_in_display "$daemon"
    "$daemon" "$@" &
    disown
}

restart_daemon dunst -icon_path "$HOME/.cache/dunsticons"

if [[ "$wm" == 'i3' ]]; then
    kill_processes_in_display "polybar"
    if [[ -n "$DISPLAYNAME_LEFT" ]]; then
        DISPLAYNAME="$DISPLAYNAME_LEFT" polybar --config="$HOME/.config/polybar" left &
    fi
    if [[ -n "$DISPLAYNAME_CENTER" ]]; then
        DISPLAYNAME="$DISPLAYNAME_CENTER" polybar --config="$HOME/.config/polybar" center &
    fi
    if [[ -n "$DISPLAYNAME_RIGHT" ]]; then
        DISPLAYNAME="$DISPLAYNAME_RIGHT" polybar --config="$HOME/.config/polybar" right &
    fi

    restart_daemon "$DOTFILE_DIR/bin/i3/mmpd"
    restart_daemon xss-lock "$DOTFILE_DIR/bin/gui/lockscreen"
    restart_daemon unclutter --display "$DISPLAY" --timeout "$CURSOR_HIDE_TIME_SECONDS"
elif [[ "$wm" == 'sway' ]]; then
    kill_processes_in_display "waybar"
    for monitor_precedence in 'PRIMARY' 'SECONDARY' 'TERTIARY'; do
        waybar \
            --bar "$monitor_precedence" \
            --config "$HOME/.config/waybar/config-${display_profile}-${monitor_precedence}.json" \
            --style "$HOME/.config/waybar/style-${display_profile}.css" &
    done
    restart_daemon swayidle \
        before-sleep '$DOTFILE_DIR/bin/gui/lockscreen' \
        timeout 600 '$DOTFILE_DIR/bin/gui/lockscreen' \
        timeout 1200 'swaymsg "output * dpms off"' \
        resume 'swaymsg "output * dpms on"'
fi
