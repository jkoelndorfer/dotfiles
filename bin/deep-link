#!/bin/zsh

target_dir="$(realpath -e "$2")"
source_dir="$(realpath --relative-to="$target_dir" -e "$1")"

SED_EXPR="s#^${source_dir}#${target_dir}#"
EXCLUDE_PATTERN="/[.]git($|/)"
find "$source_dir" -type d | egrep -v "$EXCLUDE_PATTERN" | sed -e "$SED_EXPR" | xargs mkdir -p
find "$source_dir" -type f | egrep -v "$EXCLUDE_PATTERN" | while read f; do
	link_target="$f"
	file_path="${f#${source_dir}/}"
	num_subdirs="$(echo "$file_path" | grep -o '/' | wc -l)"
	dirs_up=""
	for i in {0..$num_subdirs}; do
		if [ "$i" -gt 0 ]; then
			dirs_up="../${dirs_up}"
		fi
	done
	link_target="${dirs_up}${link_target}"
	link_path="${target_dir}/${file_path}"
	[ -L "$link_path" ] && rm -f "$link_path"
	ln -s "$link_target" "$link_path"
done
