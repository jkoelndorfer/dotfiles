#!/bin/bash

umask 077
TEMPDIR="/tmp/ssh-agent-persistent-${UID}"
SSH_PERSIST_FILE="${TEMPDIR}/env"

mkdir "$TEMPDIR" >/dev/null 2>&1
if ! [[ -O "$TEMPDIR" && -d "$TEMPDIR" ]]; then
    exit 1
fi

if [[ -f "$SSH_PERSIST_FILE" ]]; then
	source "$SSH_PERSIST_FILE"
fi

ssh-add -l >/dev/null 2>&1
rc=$?
if [[ "$rc" == 0 || "$rc" == 1 ]]; then
    if cat "$SSH_PERSIST_FILE"; then
        exit 0
    else
        exit 1
    fi
fi

ssh-agent | grep -E -v '^echo' > "$SSH_PERSIST_FILE"
cat "$SSH_PERSIST_FILE"
